# 📊 Улучшения страницы прогноза

## Обзор

На странице прогноза (`/posts/[slug]`) добавлены два новых компонента:

1. **PredictionResultCard** - отображение результата прогноза
2. **PredictorCard** - информация о прогнозисте и его другие прогнозы

---

## Компоненты

### 1. PredictionResultCard

**Файл:** `src/components/predictions/PredictionResultCard.tsx`

Компонент для отображения результата прогноза с полной статистикой.

**Показатели:**
- Выиграло (количество и процент)
- Проиграло (количество и процент)
- Hit Rate (процент точности)
- ROI (средний ROI)
- Всего событий
- Не определено (если есть)
- Нач��слено очков (если есть)

**Визуализация:**
- Цветные блоки для каждой метрики (зелёный, красный, синий, изумрудный)
- Прогресс-бар с распределением результатов
- Адаптивный дизайн

**Props:**
```typescript
interface PredictionResultCardProps {
  result: {
    total: number
    won: number
    lost: number
    undecided: number
    hitRate: number
    roi: number
  } | null
  status: 'pending' | 'settled'
}
```

**Состояния:**
- `result === null` - статистика не рассчитана (показывает сообщение)
- `status === 'pending'` - матч ещё не завершён
- `status === 'settled'` - результат рассчитан

---

### 2. PredictorCard

**Файл:** `src/components/predictions/PredictorCard.tsx`

Компонент для отображения информации о прогнозисте.

**Функции:**
- Аватар и имя прогнозиста
- Биография (если есть)
- Рейтинг (если есть)
- Статистика прогнозиста (Hit Rate, ROI, всего, выиграло)
- Ссылка на полный профиль
- Последние 3 прогноза с ссылками
- Ссылка на все прогнозы
- Социальные сети (сайт, Twitter, GitHub)

**Props:**
```typescript
interface PredictorCardProps {
  author: User | null
  currentPostId: string
}
```

**Загрузка данных:**
- Получает статистику из `/api/predictions/stats/[userId]`
- Получает последние прогнозы из `/api/predictions/user/[userId]?sort=recent&limit=3`
- Исключает текущий прогноз из списка последних

---

## API маршруты

### GET `/api/predictions/result/[postId]`

Получить результат прогноза.

**Параметры:**
- `postId` - ID поста-прогноза (path parameter)

**Ответ:**
```json
{
  "success": true,
  "result": {
    "total": 3,
    "won": 2,
    "lost": 1,
    "undecided": 0,
    "hitRate": 0.667,
    "roi": 0.15
  },
  "status": "settled",
  "points": 2,
  "evaluatedAt": "2024-12-17T10:00:00Z"
}
```

**Если результата нет:**
```json
{
  "success": true,
  "result": null,
  "status": "pending"
}
```

---

## Интеграция на странице прогноза

**Файл:** `src/app/(frontend)/(site)/posts/[slug]/page.tsx`

На странице прогноза добавлена сетка 2/3 + 1/3:

```
┌─────────────────────────────────────────────────────────┐
│                    Заголовок прогноза                   │
└─────────────────────────────────────────────────────────┘

┌──────────────────────────────────┬─────────────────────┐
│                                  │                     │
│   PredictionResultCard           │  PredictorCard      │
│   (результат прогноза)           │  (информация о      │
│   - Выиграло                     │   прогнозисте)      │
│   - Проиграло                    │  - Аватар           │
│   - Hit Rate                     │  - Статистика       │
│   - ROI                          │  - Последние        │
│   - Прогресс-бар                 │    прогнозы         │
│                                  │  - Контакты         │
└──────────────────────────────────┴─────────────────────┘

┌─────────────────────────────────────────────────────────┐
│              Информация о матче и исходах               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                      Комментарии                        │
└─────────────────────────────────────────────────────────┘
```

---

## Использование

### На странице прогноза

Компоненты автоматически загружаются и отображаются на странице прогноза:

```tsx
<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
  {/* Результат - 2/3 ширины */}
  <div className="lg:col-span-2">
    <PredictionResultContainer postId={String(post.id)} />
  </div>

  {/* Информация о прогнозисте - 1/3 ширины */}
  <div className="lg:col-span-1">
    <PredictorCard author={author} currentPostId={String(post.id)} />
  </div>
</div>
```

### Отдельное использование

Компоненты можно использовать отдельно:

```tsx
import { PredictionResultCard } from '@/components/predictions/PredictionResultCard'
import { PredictorCard } from '@/components/predictions/PredictorCard'

export function MyComponent() {
  const result = {
    total: 50,
    won: 30,
    lost: 15,
    undecided: 5,
    hitRate: 0.6,
    roi: 0.12,
  }

  return (
    <>
      <PredictionResultCard result={result} status="settled" />
      <PredictorCard author={user} currentPostId="post-id" />
    </>
  )
}
```

---

## Стили и дизайн

### Цветовая схема

- 🟢 **Зелёный** - выигрыши, прибыль
- 🔴 **Красный** - проигрыши, убытки
- 🔵 **Синий** - Hit Rate
- 🟢 **Изумрудный** - ROI (если положительный)
- 🟠 **Оранжевый** - ROI (если отрицательный)

### Компоненты UI

- `Card` - контейнер
- `Badge` - бейджи со статусом
- `Button` - кнопки
- `UserAvatar` - аватар пользователя
- Tailwind CSS для стилизации

---

## Производительность

### Оптимизация

1. **Ленивая загрузка** - компоненты загружаются при монтировании
2. **Кэширование** - данные кэшируются на клиенте
3. **Параллельные запросы** - API запросы выполняются параллельно
4. **Ограничение данных** - последние прогнозы ограничены 3 элементами

### Возможные улучшения

- [ ] Добавить кэширование на уровне браузера (localStorage)
- [ ] Добавить SWR для автоматического обновления
- [ ] Добавить скелетоны загрузки
- [ ] Добавить пагинацию для последних прогнозов

---

## Примеры

### Результат прогноза

```
┌──────────────────────���──────────────────┐
│ 📈 Результат прогноза                   │
│ Статистика по всем событиям             │
├─────────────────────────────────────────┤
│ ┌──────────┬──────────┬──────────┬────┐ │
│ │ ✅ Выиг  │ ❌ Проиг │ 📊 Hit   │ROI │ │
│ │ 30 (60%) │ 15 (30%) │ 60.0%    │+12%│ │
│ └──────────┴──────────┴──────────┴────┘ │
│                                         │
│ Всего событий: 50                       │
│ Не определено: 5                        │
│ Начислено очков: 2                      │
│                                         │
│ [████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░] │
│ ● Выиграло ● Проиграло ● Не определено │
└─────────────────────────────────────────┘
```

### Информация о прогнозисте

```
┌─────────────────────────────────────────┐
│ 📈 О прогнозисте                        │
├─────────────────────────────────────────┤
│ [👤] Иван Петров                        │
│      Опытный прогнозист                 │
│      Рейтинг: 1250                      │
│                                         │
│ ┌──────────┬──────────┐                 │
│ │ Hit Rate │ ROI      │                 │
│ │ 65.2%    │ +18.5%   │                 │
│ └──────────┴──────────┘                 │
│                                         │
│ [Полный профиль →]                      │
│                                         │
│ Последние прогнозы:                     │
│ • Прогноз на матч... 2/3 (66%)          │
│ • Прогноз на матч... 1/2 (50%)          │
│ • Прогноз на матч... 3/3 (100%)         │
│                                         │
│ [Все прогнозы →]                        │
│                                         │
│ Контакты:                               │
│ Сайт  X/Twitter  GitHub                 │
└─────────────────────────────────────────┘
```

---

## Тестирование

### Проверка компонентов

1. Откройте страницу прогноза: `/posts/[slug]`
2. Убедитесь что видны оба компонента
3. Проверьте что статистика загружается
4. Проверьте что последние прогнозы отображаются
5. Проверьте что ссылки работают

### Проверка API

```bash
# Получить результат прогноза
curl http://localhost:3100/api/predictions/result/POST_ID

# Получить статистику прогнозиста
curl http://localhost:3100/api/predictions/stats/USER_ID

# Получить последние прогнозы
curl http://localhost:3100/api/predictions/user/USER_ID?sort=recent&limit=3
```

---

## Возможные проблемы

### Результат не отображается

**Причины:**
1. Статистика не рассчитана - запустите скрипт подсчёта
2. API маршрут не работает - проверьте консоль браузера
3. Неверный postId - проверьте URL

**Решение:**
```bash
node --loader @esbuild-kit/esm-loader scripts/prediction-stats/calculate-all.mjs
```

### Информация о прогнозисте не загружается

**Причины:**
1. Пользователь не авторизован
2. API маршрут не работает
3. Нет статистики для пользователя

**Решение:**
- Проверьте консоль браузера на ошибки
- Проверьте сетевые запросы в DevTools
- Убедитесь что у пользователя есть прогнозы

---

## Файлы

```
src/
├── components/predictions/
│   ├── PredictionResultCard.tsx          ✅ НОВЫЙ
│   └── PredictorCard.tsx                 ✅ НОВЫЙ
├── app/api/predictions/
│   └── result/[postId]/route.ts          ✅ НОВЫЙ
└── app/(frontend)/(site)/posts/[slug]/
    └── page.tsx                          ✅ ОБНОВЛЁН

docs/
└── PREDICTION_PAGE_ENHANCEMENTS.md       ✅ НОВЫЙ
```

---

## Дополнительные ресурсы

- [Документация по профилю пользователя](./USER_PROFILE_STATS.md)
- [Документация по скриптам подсчёта](./PREDICTION_STATS_CALCULATION.md)
- [Структура PredictionStats](../src/collections/PredictionStats.ts)
