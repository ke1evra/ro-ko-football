# üìä Docker Compose –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

## –û–ø–∏—Å–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —á–µ—Ä–µ–∑ Docker Compose.

## –§–∞–π–ª—ã

- `docker-compose.prediction-stats.yml` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç `calculate-all.mjs` –≤ —Ä–µ–∂–∏–º–µ loop —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 10 –º–∏–Ω—É—Ç (600000 –º—Å).

–°–∫—Ä–∏–ø—Ç:
1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `posts` —Å —Ç–∏–ø–æ–º `prediction`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
3. –ï—Å–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ—Ç –∏ –≤—Å–µ –º–∞—Ç—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç
4. –ñ–¥–µ—Ç 10 –º–∏–Ω—É—Ç –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç

## –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–æ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

```bash
# –ó–∞–ø—É—Å–∫
docker compose -f docker-compose.prediction-stats.yml up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker compose -f docker-compose.prediction-stats.yml logs -f

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker compose -f docker-compose.prediction-stats.yml down
```

### –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /path/to/project

# –ó–∞–ø—É—Å–∫
docker compose -f docker-compose.prediction-stats.yml up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker compose -f docker-compose.prediction-stats.yml ps

# –õ–æ–≥–∏
docker compose -f docker-compose.prediction-stats.yml logs -f prediction_stats_calculator
```

## –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ Docker)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—á–µ—Ç –≤—Ä—É—á–Ω—É—é –±–µ–∑ Docker:

```bash
# –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç
pnpm run predictions:stats:calc

# –†–∞—Å—á–µ—Ç —Å –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
pnpm run predictions:stats:calc:force

# –ó–∞–ø—É—Å–∫ –≤ loop —Ä–µ–∂–∏–º–µ (–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞)
pnpm run predictions:stats:calc:loop
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ä–∞—Å—á–µ—Ç–∞–º–∏ - 10 –º–∏–Ω—É—Ç (600000 –º—Å).

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `docker-compose.prediction-stats.yml`:

```yaml
command: pnpm predictions:stats:calc:loop --interval=300000  # 5 –º–∏–Ω—É—Ç
```

–ò–ªÔøΩÔøΩ –≤ `package.json`:

```json
"predictions:stats:calc:loop": "tsx scripts/prediction-stats/calculate-all.mjs --loop --interval=300000"
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker compose -f docker-compose.prediction-stats.yml logs --tail=100 -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ MongoDB
mongosh 'mongodb://syncadmin:syncadminsyncadmin123qQ!@127.0.0.1:27017/payload?authSource=admin' \
  --eval 'db.predictionstats.countDocuments()'
```

### –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ª–æ–≥–∞—Ö

```
[LOOP] –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 600 —Å–µ–∫

[LOOP] === –ò—Ç–µ—Ä–∞—Ü–∏—è 1 ===
üöÄ –ó–∞–ø—É—Å–∫ –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤...

üìä –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: 5

üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ 6941805dbf951662b3afabaa (–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–∞—Ç—á...)...
   –†–µ–∑—É–ª—å—Ç–∞—Ç: 1/1 (100.0%)
   ROI: 200.0%

==================================================
üìà –ò–¢–û–ì–ò:
==================================================
–í—Å–µ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: 5
–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 1
–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤—ã—Ö: 1
–û–±–Ω–æ–≤–ª–µ–Ω–æ: 0
–ü—Ä–æ–ø—É—â–µ–Ω–æ: 4
–û—à–∏–±–æ–∫: 0
==================================================

[LOOP] –û–∂–∏–¥–∞–Ω–∏–µ 600 —Å–µ–∫ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏...
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–º–ø–æ—Ä—Ç–æ–º –º–∞—Ç—á–µ–π

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:

```bash
# –ò–º–ø–æ—Ä—Ç –º–∞—Ç—á–µ–π
docker compose -f docker-compose.matches-import-forward.yml up -d

# –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
docker compose -f docker-compose.prediction-stats.yml up -d
```

–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. `matches-import-forward` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –º–∞—Ç—á–∏ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
2. `prediction-stats` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

## –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –º–∞—Ç—á–µ–π
docker compose -f docker-compose.matches-import-forward.yml down

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
docker compose -f docker-compose.prediction-stats.yml down

# –ò–ª–∏ –≤—Å–µ —Å—Ä–∞–∑—É
docker compose -f docker-compose.matches-import-forward.yml down && \
docker compose -f docker-compose.prediction-stats.yml down
```

## Troubleshooting

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω:
   ```bash
   docker compose -f docker-compose.prediction-stats.yml ps
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏:
   ```bash
   docker compose -f docker-compose.prediction-stats.yml logs --tail=50
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–∞—Ç—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã:
   ```bash
   mongosh 'mongodb://...' --eval 'db.matches.find({status: "finished"}).count()'
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–æ–≥–Ω–æ–∑—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
   ```bash
   mongosh 'mongodb://...' --eval 'db.posts.find({postType: "prediction"}).count()'
   ```

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`:
- `DATABASE_URI` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º
- `PAYLOAD_SECRET` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–¥–∞–Ω

### –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker compose -f docker-compose.prediction-stats.yml down

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Ä—É—á–Ω—É—é
pnpm run predictions:stats:recalc

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–Ω–æ–≤–∞
docker compose -f docker-compose.prediction-stats.yml up -d
```

## PM2 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

–ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ PM2:

```javascript
// ecosystem.config.cjs
module.exports = {
  apps: [
    {
      name: 'prediction-stats',
      script: 'pnpm',
      args: 'run predictions:stats:calc:loop',
      cwd: '/path/to/project',
      autorestart: true,
      watch: false,
      max_memory_restart: '500M',
      env: {
        NODE_ENV: 'production',
      },
    },
  ],
}
```

```bash
pm2 start ecosystem.config.cjs --only prediction-stats
pm2 logs prediction-stats
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò–Ω—Ç–µ—Ä–≤–∞–ª**: 10 –º–∏–Ω—É—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
3. **Backup**: –î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤—ã–º –ø–µ—Ä–µ—Å—á–µ—Ç–æ–º
4. **–ù–∞–≥—Ä—É–∑–∫–∞**: –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ —É–≤–µ–ª–∏—á—å—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª

## –°–º. —Ç–∞–∫–∂–µ

- `WORKERS.md` - –æ–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ñ–æ–Ω–æ–≤—ã–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º
- `docs/PREDICTION_STATS_CALCULATION.md` - –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- `scripts/prediction-stats/README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–∫—Ä–∏–ø—Ç–∞–º
